(function(G,Y){typeof exports=="object"&&typeof module<"u"?Y(exports):typeof define=="function"&&define.amd?define(["exports"],Y):(G=typeof globalThis<"u"?globalThis:G||self,Y(G.ZRS={}))})(this,function(G){"use strict";var $n=Object.defineProperty;var Nn=(G,Y,I)=>Y in G?$n(G,Y,{enumerable:!0,configurable:!0,writable:!0,value:I}):G[Y]=I;var p=(G,Y,I)=>Nn(G,typeof Y!="symbol"?Y+"":Y,I);class Y{constructor(){p(this,"behaviorTasks");this.behaviorTasks=new Map}get getBehaviorTasksSize(){return this.behaviorTasks.size}addBehavior(t,e,s,i,o){this.behaviorTasks.set(t,{event:e,call:s,interval:i,lastExecuteTime:o?performance.now()-i:performance.now()})}delBehavior(t){return this.behaviorTasks.delete(t)}delBehaviorAll(){this.behaviorTasks.clear()}behaviorProcess(t){this.behaviorTasks.forEach((e,s)=>{let i=t-e.lastExecuteTime;if(i>e.interval){e.lastExecuteTime=t-i%e.interval;const o=e.event();e.call&&e.call(o)}})}}const I=new Y;function Bt(n,t,e=0,s=n.length-1,i=Ae){for(;s>e;){if(s-e>600){const u=s-e+1,c=t-e+1,l=Math.log(u),h=.5*Math.exp(2*l/3),f=.5*Math.sqrt(l*h*(u-h)/u)*(c-u/2<0?-1:1),g=Math.max(e,Math.floor(t-c*h/u+f)),S=Math.min(s,Math.floor(t+(u-c)*h/u+f));Bt(n,t,g,S,i)}const o=n[t];let r=e,a=s;for(j(n,e,t),i(n[s],o)>0&&j(n,e,s);r<a;){for(j(n,r,a),r++,a--;i(n[r],o)<0;)r++;for(;i(n[a],o)>0;)a--}i(n[e],o)===0?j(n,e,a):(a++,j(n,a,s)),a<=t&&(e=a+1),t<=a&&(s=a-1)}}function j(n,t,e){const s=n[t];n[t]=n[e],n[e]=s}function Ae(n,t){return n<t?-1:n>t?1:0}class _t{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const s=[];if(!lt(t,e))return s;const i=this.toBBox,o=[];for(;e;){for(let r=0;r<e.children.length;r++){const a=e.children[r],u=e.leaf?i(a):a;lt(t,u)&&(e.leaf?s.push(a):mt(t,u)?this._all(a,s):o.push(a))}e=o.pop()}return s}collides(t){let e=this.data;if(!lt(t,e))return!1;const s=[];for(;e;){for(let i=0;i<e.children.length;i++){const o=e.children[i],r=e.leaf?this.toBBox(o):o;if(lt(t,r)){if(e.leaf||mt(t,r))return!0;s.push(o)}}e=s.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let s=0;s<t.length;s++)this.insert(t[s]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const s=this.data;this.data=e,e=s}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=$([]),this}remove(t,e){if(!t)return this;let s=this.data;const i=this.toBBox(t),o=[],r=[];let a,u,c;for(;s||o.length;){if(s||(s=o.pop(),u=o[o.length-1],a=r.pop(),c=!0),s.leaf){const l=Ie(t,s.children,e);if(l!==-1)return s.children.splice(l,1),o.push(s),this._condense(o),this}!c&&!s.leaf&&mt(s,i)?(o.push(s),r.push(a),a=0,u=s,s=s.children[0]):u?(a++,s=u.children[a],c=!1):s=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const s=[];for(;t;)t.leaf?e.push(...t.children):s.push(...t.children),t=s.pop();return e}_build(t,e,s,i){const o=s-e+1;let r=this._maxEntries,a;if(o<=r)return a=$(t.slice(e,s+1)),H(a,this.toBBox),a;i||(i=Math.ceil(Math.log(o)/Math.log(r)),r=Math.ceil(o/Math.pow(r,i-1))),a=$([]),a.leaf=!1,a.height=i;const u=Math.ceil(o/r),c=u*Math.ceil(Math.sqrt(r));Tt(t,e,s,c,this.compareMinX);for(let l=e;l<=s;l+=c){const h=Math.min(l+c-1,s);Tt(t,l,h,u,this.compareMinY);for(let f=l;f<=h;f+=u){const g=Math.min(f+u-1,h);a.children.push(this._build(t,f,g,i-1))}}return H(a,this.toBBox),a}_chooseSubtree(t,e,s,i){for(;i.push(e),!(e.leaf||i.length-1===s);){let o=1/0,r=1/0,a;for(let u=0;u<e.children.length;u++){const c=e.children[u],l=dt(c),h=Te(t,c)-l;h<r?(r=h,o=l<o?l:o,a=c):h===r&&l<o&&(o=l,a=c)}e=a||e.children[0]}return e}_insert(t,e,s){const i=s?t:this.toBBox(t),o=[],r=this._chooseSubtree(i,this.data,e,o);for(r.children.push(t),K(r,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)}_split(t,e){const s=t[e],i=s.children.length,o=this._minEntries;this._chooseSplitAxis(s,o,i);const r=this._chooseSplitIndex(s,o,i),a=$(s.children.splice(r,s.children.length-r));a.height=s.height,a.leaf=s.leaf,H(s,this.toBBox),H(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(s,a)}_splitRoot(t,e){this.data=$([t,e]),this.data.height=t.height+1,this.data.leaf=!1,H(this.data,this.toBBox)}_chooseSplitIndex(t,e,s){let i,o=1/0,r=1/0;for(let a=e;a<=s-e;a++){const u=V(t,0,a,this.toBBox),c=V(t,a,s,this.toBBox),l=ke(u,c),h=dt(u)+dt(c);l<o?(o=l,i=a,r=h<r?h:r):l===o&&h<r&&(r=h,i=a)}return i||s-e}_chooseSplitAxis(t,e,s){const i=t.leaf?this.compareMinX:Be,o=t.leaf?this.compareMinY:_e,r=this._allDistMargin(t,e,s,i),a=this._allDistMargin(t,e,s,o);r<a&&t.children.sort(i)}_allDistMargin(t,e,s,i){t.children.sort(i);const o=this.toBBox,r=V(t,0,e,o),a=V(t,s-e,s,o);let u=ct(r)+ct(a);for(let c=e;c<s-e;c++){const l=t.children[c];K(r,t.leaf?o(l):l),u+=ct(r)}for(let c=s-e-1;c>=e;c--){const l=t.children[c];K(a,t.leaf?o(l):l),u+=ct(a)}return u}_adjustParentBBoxes(t,e,s){for(let i=s;i>=0;i--)K(e[i],t)}_condense(t){for(let e=t.length-1,s;e>=0;e--)t[e].children.length===0?e>0?(s=t[e-1].children,s.splice(s.indexOf(t[e]),1)):this.clear():H(t[e],this.toBBox)}}function Ie(n,t,e){if(!e)return t.indexOf(n);for(let s=0;s<t.length;s++)if(e(n,t[s]))return s;return-1}function H(n,t){V(n,0,n.children.length,t,n)}function V(n,t,e,s,i){i||(i=$(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let o=t;o<e;o++){const r=n.children[o];K(i,n.leaf?s(r):r)}return i}function K(n,t){return n.minX=Math.min(n.minX,t.minX),n.minY=Math.min(n.minY,t.minY),n.maxX=Math.max(n.maxX,t.maxX),n.maxY=Math.max(n.maxY,t.maxY),n}function Be(n,t){return n.minX-t.minX}function _e(n,t){return n.minY-t.minY}function dt(n){return(n.maxX-n.minX)*(n.maxY-n.minY)}function ct(n){return n.maxX-n.minX+(n.maxY-n.minY)}function Te(n,t){return(Math.max(t.maxX,n.maxX)-Math.min(t.minX,n.minX))*(Math.max(t.maxY,n.maxY)-Math.min(t.minY,n.minY))}function ke(n,t){const e=Math.max(n.minX,t.minX),s=Math.max(n.minY,t.minY),i=Math.min(n.maxX,t.maxX),o=Math.min(n.maxY,t.maxY);return Math.max(0,i-e)*Math.max(0,o-s)}function mt(n,t){return n.minX<=t.minX&&n.minY<=t.minY&&t.maxX<=n.maxX&&t.maxY<=n.maxY}function lt(n,t){return t.minX<=n.maxX&&t.minY<=n.maxY&&t.maxX>=n.minX&&t.maxY>=n.minY}function $(n){return{children:n,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Tt(n,t,e,s,i){const o=[t,e];for(;o.length;){if(e=o.pop(),t=o.pop(),e-t<=s)continue;const r=t+Math.ceil((e-t)/s/2)*s;Bt(n,r,t,e,i),o.push(t,r,r,e)}}const ut=["rectangle","circle","strip"];function kt(){return{highlightElements:!0,currentDragEl:null,cvs:null,containerTransformState:{lastX:0,lastY:0,offsetX:0,offsetY:0,scale:1},graphicMatrix:{groups:{rectangle:{},circle:{},strip:{}},elements:{},groupElements:{}},groupTree:new _t}}function Q(n){const t=n.getGraphicGroups(ut),e=new _t;for(const s of t.values())e.insert({...s,minX:s.x,minY:s.y,maxX:s.x+s.w,maxY:s.y+s.h});n.updateState("groupTree",e)}const z=class z{constructor(){p(this,"state");p(this,"listeners",{});this.state=kt()}static getInstance(){return z.instance||(z.instance=new z),z.instance}getState(...t){if(t.length===0)return{...this.state};if(t.length===1)return this.state[t[0]];const e={};return t.forEach(s=>{e[s]=this.state[s]}),e}updateState(t,e){const s=this.state[t];this.state[t]=e,t==="graphicMatrix"&&Q(z.getInstance()),this.notify(t,e,s)}subscribe(t,e,s=!1){this.listeners[t]||(this.listeners[t]=new Set),this.listeners[t].add(e),s&&e(this.state[t],this.state[t])}unsubscribe(t,e){var s;(s=this.listeners[t])==null||s.delete(e)}unsubscribeAll(){Object.keys(this.listeners).forEach(t=>{this.listeners[t].clear()}),this.listeners={}}notify(t,e,s){var i;(i=this.listeners[t])==null||i.forEach(o=>{o(e,s)})}getGraphicGroups(t){const e=new Map,s=Array.from(new Set(t));for(const i of s)for(const[o,r]of Object.entries(this.state.graphicMatrix.groups[i]))e.set(o,r);return e}getGraphicGroupsArr(){const t=[];for(const e of ut)for(const[s,i]of Object.entries(this.state.graphicMatrix.groups[e]))t.push(i);return t}getGraphicGroupsById(t){if(!t)return null;for(const e of ut)for(const[s,i]of Object.entries(this.state.graphicMatrix.groups[e]))if(t===s)return i;return null}getGraphicGroupElementsById(t){return this.state.graphicMatrix.groupElements[t].map(s=>this.state.graphicMatrix.elements[s])}getGraphicGroupElementById(t){const e=this.state.graphicMatrix.elements[t];return e||null}reset(){this.state=kt()}destroy(){}};p(z,"instance");let b=z;const zt=b.getInstance(),Rt=()=>zt.getState("cvs");function A(){return zt.getState("containerTransformState")}function T(n,t){const{scale:e,offsetX:s,offsetY:i}=A();return[n*e+s,t*e+i]}const ze=(n,t)=>{const{scale:e,offsetX:s,offsetY:i}=A();return[(n-s)/e,(t-i)/e]};function x(n){return n*A().scale}function Re(n,t,e){const{scale:s,offsetX:i,offsetY:o}=A(),r=Math.min(Math.max(s,.75),3),u=30*r,c=r>1?r:1,l=i%u,h=o%u;n.fillStyle="#dfdfe1";for(let f=l;f<t;f+=u)for(let g=h;g<e;g+=u)n.fillRect(f-c,g-c,c*2,c*2)}function Oe(n){I.delBehavior(n)}function De(){I.delBehaviorAll()}class Pe{constructor(t,e){p(this,"cvs");p(this,"$");p(this,"fps");p(this,"fpsInterval");p(this,"lastRenderTime");p(this,"frame");if(!e.cvs||!e.pen)throw new Error("Canvaser context is incomplete.");this.cvs=e.cvs,this.$=e.pen,this.fps=t,this.fpsInterval=1e3/this.fps,this.lastRenderTime=performance.now()}run(t){this.frame=window.requestAnimationFrame(this.run.bind(this,t));let e=performance.now(),s=e-this.lastRenderTime;s>this.fpsInterval&&(this.lastRenderTime=e-s%this.fpsInterval,this.clearScreen(),this.renderGrid(),this.renderInstances(t)),this.processBehavior(e)}clear(){this.frame&&window.cancelAnimationFrame(this.frame),De()}clearScreen(){this.$.clearRect(0,0,this.cvs.width,this.cvs.height)}renderGrid(){Re(this.$,this.cvs.width,this.cvs.height)}renderInstances(t){var e,s;for(const i in t)(s=(e=t[i])==null?void 0:e.draw)==null||s.call(e)}processBehavior(t){I.getBehaviorTasksSize&&I.behaviorProcess(t)}}class Ze{constructor(){p(this,"events",{})}subscribe(t,e){return this.events[t]||(this.events[t]=[]),this.events[t].push(e),()=>this.unsubscribe(t,e)}publish(t,...e){var s;(s=this.events[t])==null||s.forEach(i=>i(...e))}unsubscribe(t,e){const s=this.events[t];s&&(this.events[t]=s.filter(i=>i!==e))}once(t,e){const s=(...i)=>{e(...i),this.unsubscribe(t,s)};this.subscribe(t,s)}clear(t){this.events[t]&&(this.events[t]=[])}clearAll(){this.events={}}}const E=new Ze,Le=b.getInstance(),gt=(n,t,e)=>n+(t-n)*e;function ht(n,t=300){const e=performance.now(),{scale:s,offsetX:i,offsetY:o}=A(),r={offsetX:i,offsetY:o,scale:s};I.addBehavior("resetTransform",()=>{const u=performance.now()-e,c=Math.min(1,u/t),l=c*(2-c);return E.publish("calculateProportion"),c>=1&&Oe("resetTransform"),{offsetX:gt(r.offsetX,n.offsetX,l),offsetY:gt(r.offsetY,n.offsetY,l),scale:gt(r.scale,n.scale,l),lastX:0,lastY:0}},a=>{Le.updateState("containerTransformState",a)},1e3/60,!0)}function Ot(n,t,e){let s,i,o,r=0;e||(e={});let a=function(){r=e.leading===!1?0:new Date().getTime(),s=null,n.apply(i,o),s||(i=o=null)},u=function(){let c=new Date().getTime();!r&&e.leading===!1&&(r=c);let l=t-(c-r);i=this,o=arguments,l<=0||l>t?(s&&(clearTimeout(s),s=null),r=c,n.apply(i,o),s||(i=o=null)):!s&&e.trailing!==!1&&(s=setTimeout(a,l))};return u.cancel=function(){clearTimeout(s),r=0,s=null},u}function N(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const t=Math.random()*16|0;return(n==="x"?t:t&3|8).toString(16)})}function tt(n,t=new WeakMap){if(n===null||typeof n!="object")return n;if(t.has(n))return t.get(n);const e=Array.isArray(n)?[]:{};t.set(n,e);for(const s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=tt(n[s],t));return e}function Dt(n,t,e){return n.map(s=>s===t?e:s)}function Fe(n,t){const e={id:n.id,group_by:n.group_by,index:n.index,x:n.x,y:n.y,isDragging:n.isDragging,dX:n.dX,dY:n.dY,width:n.width,height:n.height,pos:n.pos?[...n.pos]:void 0,strip:n.strip?{...n.strip}:void 0,text:n.text,baseFontSize:n.baseFontSize,nameFontSize:n.nameFontSize,status:n.status};Pt(n,t),Pt(t,e)}function Pt(n,t){n.group_by=t.group_by,n.index=t.index,n.x=t.x,n.y=t.y,n.isDragging=t.isDragging,n.dX=t.dX,n.dY=t.dY,n.width=t.width,n.height=t.height,n.pos=t.pos?[...t.pos]:void 0,n.strip=t.strip?{...t.strip}:void 0}const He="rgb(255, 255, 255)",m=50,M=50,$e=30,d=10,et=d*3,w=d*1.5,xt="#f6f6f6",Et="#E3D2C3",bt="#2DAA9E",Mt="rgb(0,0,0)",Ne="#074799",Ue="rgb(0,0,0)",Zt="rgb(0,0,0)",Lt="rgb(255,255,255)",We="占座",R=b.getInstance();function Ft(n,t){const e=t*m+(t-1)*d+et,s=n*M+(n-1)*d+$e+d*2;return[e,s]}function Ht(n,t,e){let s=0;if(e&&e.fullRow!==0){const{logicalColCount:o,fullRow:r}=e,a=o*m+(o-1)*d,u=r*m+(r-1)*d;s=(a-u)/2+n*m+n*d+w}else s=n*m+d*n+w;const i=t*M+d*t+w;return{gX:s,gY:i}}function qe(n,t,e,s){const i={};let o=1;for(let r=0;r<t;r++)for(let a=0;a<e;a++){const u=`${n}-${r}-${a}`,{gX:c,gY:l}=Ht(a,r);i[u]={id:u,group_by:n,index:o,x:c,y:l,isDragging:!1,dX:0,dY:0,width:m,height:M,pos:[r,a],text:Math.random().toString(36).substr(2,2),status:"idle",baseFontSize:13,nameFontSize:10},o++}return i}function $t(n,t,e=!0){n.fillStyle=xt;const[s,i]=T(t.x,t.y),o=x(t.w),r=x(t.h);n.fillRect(s,i,o,r),n.lineWidth=x(1),n.strokeStyle=Et,t.hover&&(n.strokeStyle=bt),n.strokeRect(s,i,o,r),Je(n,t,s,i,o,r,e)}function Je(n,t,e,s,i,o,r=!0){q(n,Mt,"center","alphabetic",t.baseFontSize),n.fillText(`区域名称：${t.group_name}`,e+i/2,s+o-(r?x(d):d))}function Nt(n,t){return{x:n.x+t.x,y:n.y+t.y}}function Ut(n,t,e){if(!t.isDragging){const s=Nt(e,t),[i,o]=T(s.x,s.y),r=x(t.width),a=x(t.height);St(n,t,i,o,r,a)}}function je(n,t,e,s){const i=R.getGraphicGroupElementById(t.id);if(!i)return;const o=R.getState("graphicMatrix"),r=R.getGraphicGroupElementsById(n.group_id);for(const c of r)if(c.pos[0]===i.pos[0])switch(e){case"before":c.pos[1]>=i.pos[1]&&(c.pos[1]=c.pos[1]+s);break;case"after":c.pos[1]>i.pos[1]&&(c.pos[1]=c.pos[1]+s);break}const a=[],u={};for(let c=1;c<=s;c++){const l=N();let h=[0,0];switch(e){case"before":h=[i.pos[0],i.pos[1]-c];break;case"after":h=[i.pos[0],i.pos[1]+c];break}a.push(Gt(l,n,0,0,0,h,`测试${c}`))}o.elements={...o.elements,...a.reduce((c,l)=>(c[l.id]=l,c),u)},o.groupElements[n.group_id]=[...o.groupElements[n.group_id],...a.map(c=>c.id)],Wt(n.group_id)}function Ve(n){const t=new Set,e=new Set;for(const s of n){const[i,o]=s.pos;t.add(i),e.add(o)}return{logicalRowCount:t.size,logicalColCount:e.size,matrixRowCount:Math.max(...t)+1,matrixColCount:Math.max(...e)+1}}function Ke(n){const t=new Set;for(const o of n)t.add(o.pos[0]);const e=[...t].sort((o,r)=>o-r),s=new Map;e.forEach((o,r)=>{s.set(o,r)});const i=new Map;for(const o of n){const[r]=o.pos,a=s.get(r);i.has(a)||i.set(a,[]),i.get(a).push(o)}for(const[o,r]of i.entries())r.sort((a,u)=>a.pos[1]-u.pos[1]),r.forEach((a,u)=>{a.pos=[o,u]})}function Qe(n){const t=new Map;for(const s of n){const[i,o]=s.pos;t.has(i)||t.set(i,[]),t.get(i).push(o)}const e=new Map;for(const[s,i]of t.entries()){const o=i.sort((a,u)=>a-u),r=new Map;o.forEach((a,u)=>r.set(a,u)),e.set(s,r)}return e}function tn(n,t,e){const s=new Set;for(const i of n){const[o,r]=i.pos;o===t&&s.add(r)}return s.size===e?0:s.size}function Wt(n){const t=R.getGraphicGroupsById(n);if(!t)return;const e=R.getGraphicGroupElementsById(n),s=e.length;Ke(e);const i=new Map,o=[];for(const f of e)o.push({pos:f.pos}),i.set(f.pos.toString(),f.id);console.log(e);const{logicalRowCount:r,logicalColCount:a}=Ve(o);console.log(r,a);const[u,c]=Ft(r,a);t.w=u,t.h=c,t.size=s;const l=Qe(o);let h=1;for(let f=0;f<r;f++){const g=tn(o,f,a);for(let S=0;S<a;S++)if(i.has(`${f},${S}`)){const F=R.getGraphicGroupElementById(i.get(`${f},${S}`));if(F){const y=l.get(f).get(S),{gX:At,gY:It}=Ht(y,f,{logicalColCount:a,fullRow:g});F.x=At,F.y=It,F.index=h,F.pos=[f,S]}h++}}Q(R)}const nt=b.getInstance(),en=m+d*2,qt=40;function Jt(n){const t=m+d,e=Math.max(n*t/(2*Math.PI),50),s=(e+en)*2;return{radius:e,w:s,h:s}}function jt(n,t){const e=2*Math.PI*t/n.size-Math.PI/2,s=(n.radius+qt)*Math.cos(e)-m/2,i=(n.radius+qt)*Math.sin(e)-M/2;return[s,i]}function nn(n){const t={};for(let e=0;e<n.size;e++){const[s,i]=jt(n,e),o=`${n.group_id}-${e}`;t[o]=Gt(o,n,e+1,s,i)}return t}function sn(n,t,e,s){const i=nt.getState("graphicMatrix"),r=nt.getGraphicGroupElementsById(n.group_id).sort((l,h)=>l.index-h.index).map(l=>l.id),a=[];for(let l=0;l<s;l++){const h=N();a.push(Gt(h,n,0,0,0,void 0,`测试${l}`))}const u=r.indexOf(t.id);r.splice(e==="before"?u:u+1,0,...a.map(l=>l.id));const c={};i.elements={...i.elements,...a.reduce((l,h)=>(l[h.id]=h,l),c)},i.groupElements[n.group_id]=r,Vt(n.group_id)}function Vt(n){const t=nt.getGraphicGroupsById(n);if(!t)return;const e=nt.getGraphicGroupElementsById(n),s=e.length,{radius:i,w:o,h:r}=Jt(s);t.w=o,t.h=r,t.radius=i,t.size=s;for(let a=0;a<t.size;a++){const[u,c]=jt(t,a);e[a].x=u,e[a].y=c,e[a].index=a+1}Q(nt)}function Kt(n,t){n.fillStyle=xt;const[e,s]=T(t.x,t.y),i=x(t.w),o=x(t.h),r=x(t.radius),a={x:e+i/2,y:s+o/2};n.fillRect(e,s,i,o),n.strokeStyle=Et,n.beginPath(),n.arc(a.x,a.y,r,0,2*Math.PI),n.stroke(),n.fillStyle=Lt,n.fill(),t.hover&&(n.strokeStyle=bt),n.strokeRect(e,s,i,o),on(n,t,a)}function on(n,t,e){q(n,Mt,"center","middle",t.baseFontSize),n.fillText(`${t.group_name}`,e.x,e.y)}function Qt(n,t){return{x:n.x+t.x+n.w/2,y:n.y+t.y+n.h/2}}function te(n,t,e){if(!t.isDragging){const s=x(t.width),i=x(t.height),o=Qt(e,t),[r,a]=T(o.x,o.y);St(n,t,r,a,s,i)}}const U=b.getInstance();function ee(n,t){const e=t+2,s=n+2,i=s*m+(s-1)*d+et,o=e*M+(e-1)*d+et;return[i,o]}function st(n,t,e,s,i,o,r,a){return{id:n,group_by:t,index:e,x:s,y:i,isDragging:!1,dX:0,dY:0,width:m,height:M,strip:{pos:o,idx:r},text:a||Math.random().toString(36).substr(2,2),status:"idle",baseFontSize:13,nameFontSize:10}}function rn(n,t,e){const s={};let i=1;const o=w;for(let c=0;c<t;c++){const l=`${n}-top-${c}`,h=m+d+c*m+d*c+w,f=o;s[l]=st(l,n,i,h,f,"top",c),i++}const r=s[`${n}-top-${t-1}`].x+m+d;for(let c=0;c<e;c++){const l=`${n}-right-${c}`,h=r,f=M+d+c*M+d*c+w;s[l]=st(l,n,i,h,f,"right",c),i++}const a=s[`${n}-right-${e-1}`].y+m+d;for(let c=t;c>0;c--){const l=`${n}-bottom-${c}`,h=c*m+d*c+w,f=a;s[l]=st(l,n,i,h,f,"bottom",c),i++}const u=w;for(let c=e;c>0;c--){const l=`${n}-left-${c}`,h=u,f=c*M+d*c+w;s[l]=st(l,n,i,h,f,"left",c),i++}return s}function ne(n,t,e=!0){n.fillStyle=xt;const[s,i]=T(t.x,t.y),o=x(t.w),r=x(t.h);n.fillRect(s,i,o,r),n.strokeStyle=Et,an(n,s,i,o,r,e),t.hover&&(n.strokeStyle=bt),n.strokeRect(s,i,o,r),cn(n,t,s,i,o,r)}function an(n,t,e,s,i,o=!0){const r=o?x(m+et):m+et,a={x:t+r,y:e+r,w:s-r*2,h:i-r*2};n.beginPath(),n.strokeRect(a.x,a.y,a.w,a.h),n.fillStyle=Lt,n.fillRect(a.x,a.y,a.w,a.h)}function cn(n,t,e,s,i,o){q(n,Mt,"center","middle",t.baseFontSize),n.fillText(`${t.group_name}`,e+i/2,s+o/2)}function se(n,t){return{x:n.x+t.x,y:n.y+t.y}}function ie(n,t,e){if(!t.isDragging){const s=se(e,t),[i,o]=T(s.x,s.y),r=x(t.width),a=x(t.height);St(n,t,i,o,r,a)}}function ln(n){const t={top:[],right:[],bottom:[],left:[]};for(const e of n)t[e.strip.pos].push(e);for(const e of Object.keys(t)){const s=t[e];s.sort((i,o)=>i.strip.idx-o.strip.idx),s.forEach((i,o)=>{i.strip.idx=o})}}function un(n,t,e,s){const i=U.getGraphicGroupElementById(t.id);if(!i)return;const o=i.strip.idx,r=U.getState("graphicMatrix"),a=U.getGraphicGroupElementsById(n.group_id);for(const l of a)if(l.strip.pos===i.strip.pos)switch(e){case"before":l.strip.idx>=o&&(l.strip.idx=l.strip.idx+s);break;case"after":l.strip.idx>o&&(l.strip.idx=l.strip.idx+s);break}const u=[],c={};for(let l=1;l<=s;l++){const h=N();let f=0,g=i.strip.pos;switch(e){case"before":f=i.strip.idx-l;break;case"after":f=i.strip.idx+l;break}u.push(st(h,n.group_id,0,0,0,g,f,`测试${l}`))}r.elements={...r.elements,...u.reduce((l,h)=>(l[h.id]=h,l),c)},r.groupElements[n.group_id]=[...r.groupElements[n.group_id],...u.map(l=>l.id)],oe(n.group_id)}function oe(n){const t=U.getGraphicGroupsById(n);if(!t)return;const e=U.getGraphicGroupElementsById(n),s=e.length,i={top:0,right:0,bottom:0,left:0};ln(e);for(const l of e)switch(l.strip.pos){case"top":i.top++;break;case"right":i.right++;break;case"bottom":i.bottom++;break;case"left":i.left++;break}const o=Math.max(i.top,i.bottom,1),r=Math.max(i.left,i.right,1),[a,u]=ee(o,r);t.w=a,t.h=u,t.size=s;let c=1;for(const l of e.filter(h=>h.strip.pos==="top").sort((h,f)=>h.strip.idx-f.strip.idx)){const f=(o-i.top)*((m+d)/2)+m+d+l.strip.idx*m+d*l.strip.idx+w,g=w;l.x=f,l.y=g,l.index=c,c++}for(const l of e.filter(h=>h.strip.pos==="right").sort((h,f)=>h.strip.idx-f.strip.idx)){const h=r-i.right,g=m+d+o*m+d*o+w,S=h*((M+d)/2)+M+d+l.strip.idx*M+d*l.strip.idx+w;l.x=g,l.y=S,l.index=c,c++}for(const l of e.filter(h=>h.strip.pos==="bottom").sort((h,f)=>h.strip.idx-f.strip.idx)){const h=M+d+r*M+d*r+w,g=(o-i.bottom)*((m+d)/2)+m+d+l.strip.idx*m+d*l.strip.idx+w,S=h;l.x=g,l.y=S,l.index=c,c++}for(const l of e.filter(h=>h.strip.pos==="left").sort((h,f)=>h.strip.idx-f.strip.idx)){const h=r-i.left,f=w,g=h*((M+d)/2)+M+d+l.strip.idx*M+d*l.strip.idx+w;l.x=f,l.y=g,l.index=c,c++}Q(U)}const W=b.getInstance(),hn=n=>{if(W.getState("highlightElements")){const t=D(n);t&&fn(t)}};let re=new Set;function ae(n){for(const t of re)if(!n.has(t)){const e=W.getGraphicGroupsById(t);e&&(e.hover=!1,e.z_index=0)}for(const t of n.values()){const e=W.getGraphicGroupsById(t);e&&(e.hover=!0,e.z_index=1)}re=n}function fn({mx:n,my:t}){const i=W.getState("groupTree").search({minX:n,minY:t,maxX:n,maxY:t}).sort((r,a)=>a.z_index-r.z_index).map(r=>r.group_id),o=new Set([i[0]]);ae(o)}const pn=Ot(hn,150),ce=n=>{const t=D(n);if(t){const s=W.getState("groupTree").search({minX:t.mx,minY:t.my,maxX:t.mx,maxY:t.my});return s.length===0?null:s.reduce((o,r)=>r.z_index>o.z_index?r:o,s[0])}return null},le=(n,t)=>{const e=D(n);if(e){const{mx:s,my:i}=e,o=W.getGraphicGroupElementsById(t.group_id);for(const r of o){const{width:a,height:u}=r;let c=0,l=0;switch(t.type){case"rectangle":({x:c,y:l}=Nt(t,r));break;case"circle":({x:c,y:l}=Qt(t,r));break;case"strip":({x:c,y:l}=se(t,r));break}if(s>=c&&s<=c+a&&i>=l&&i<=l+u)return r}}return null};function dn(n=""){return n.split("/").pop()}const ue=n=>{const t=[];for(const e of n)t.push(new Promise((s,i)=>{const o=new Image;o.src=e,o.onload=function(){createImageBitmap(o).then(r=>{s({name:dn(e),uri:o,width:o.width,height:o.height,bitmap:r})}).catch(i)},o.onerror=function(){i(new Error(`load img error: ${e}`))}}));return Promise.all(t)},mn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAMAAAAPdrEwAAAAYFBMVEUAAACMxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf+Mxf9itJhsAAAAH3RSTlMAliLdaXiHWuv7u9LIMhbvsqaR9d69cGJPTCkeDGZBhT6b/AAAAPxJREFUWMPt01lOxDAQhOEaExKbOM4y+wJ9/1sSYIRGwmHEuFu81H+A76Gkws/cbmx7+UN9O+4c7neI8lDxcAc+b+Xhtmf8UuelIN9hMddLUf3y4lEKi1iokeIa5GvL6RbZkiiUkOuoQb8ZTT3XkP4f+lKNL3MNag26xvFDG6sLkK5HecZKg16hup4nYRIbWiZsrOgNghUdIFa0kCZNmjRp0qRJkyZNmjRp0qRJkyZNeoFOTqGUpXXK0P5JKf9NBzEqwItRHlGMipjEqAkno7HDCdib2GGPOfdaf6ZjflmVw206NHJ5DblHrkGDHpCrW5fL6w55eyjcxA+38juKQFJKYbX+lQAAAABJRU5ErkJggg==",gn="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAMAAAAPdrEwAAAAXVBMVEUAAACZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmZmIF5V4AAAAHnRSTlMALdIiM92pvPp3WuyQiDwnzvFMaQhhQxzHsm8UnIbSJbCXAAABTUlEQVRYw+3Zy26DMBCF4cHYxI0dbG4J5HLe/zGb0gYhNW5aBtTN/FtL32LkWQ19Lz8XqsIfqlRxzul1dY9F9fUL+LQDoHx31CH/ZUEfO68A7E4/ydoB10ALClfAaUqWO5iSFlYaVOmJ9zAnWtxFoadEe9iMGAWLfeIpwhOrA2LidwAZj86A5wOtUREzh2Ni1IpLK+yF/h+6bYrdmFqDVp9W0bTjek6x6bl1IY/Kv435NeiH5eDJoJl2iU9P+9zBkEW5Ba1hCci2oDNAaKGFFlpooYUWWmihhRZaaKGFFlpooYVO0tYws0maX4Ju8xVqZ7SFpg3SsImjBLsjHEWcaYMaRPKI7fpyG+EpWJjiq8AVw0MysHess3hUculyomxH9/LmdvhoHXqkbk1O89ahE7exmkvXcPSsAbHWrOqI4SmtK7CrdGI5BwdWbpjL7/6mZ3qtwG0OAAAAAElFTkSuQmCC",J=class J{static async load(){const[t]=await ue([mn]);J.onSeat=t;const[e]=await ue([gn]);J.unSeat=e}};p(J,"onSeat"),p(J,"unSeat");let it=J;const O=b.getInstance(),he=10;function xn(n){return O.getGraphicGroups(ut)}function q(n,t,e,s="alphabetic",i=13){n.font=`${x(i)}px Arial`,n.fillStyle=t,n.textAlign=e,n.textBaseline=s}function En(n,t){const{x:e,y:s,w:i,h:o}=n;for(const r of t.values())if(!(e+i<=r.x||e>=r.x+r.w||s+o<=r.y||s>=r.y+r.h))return!0;return!1}function wt(n,t){const{scale:e,offsetX:s,offsetY:i}=A(),o=Rt().width/e,r=xn(),a=-s/e,u=-i/e;let c=a+o-n;const l=10;a>c&&(c=n);for(let h=u;;h+=l)for(let f=a;f<c;f+=l){if(En({x:f,y:h,w:n,h:t},r)){f+=n;continue}return[f+he,h+he]}}let X=null,ot=null;function fe(n){ot=n,X=n.getBoundingClientRect()}function yt(n){if(X){const t=n.clientX,e=n.clientY;return t-8>=X.left&&t+8<=X.right&&e-8>=X.top&&e+8<=X.bottom}return!1}const D=n=>{const{offsetX:t,offsetY:e,scale:s}=A();if(X&&ot){const i=(n.clientX-X.left)*(ot.width/X.width),o=(n.clientY-X.top)*(ot.height/X.height),r=(i-t)/s,a=(o-e)/s;return{mx:r,my:a}}return null};function bn(n,t){const e=ce(n);if(e){const s=le(n,e);if(s){if(s.id===t.id)return;const i=O.getState("graphicMatrix"),o=t.group_by,r=s.group_by;Fe(t,s),o!==r&&(i.groupElements[o]=Dt(i.groupElements[o],t.id,s.id),i.groupElements[r]=Dt(i.groupElements[r],s.id,t.id))}}}function Mn(n,t,e,s,i){const o=O.getState("currentDragEl");if(o){const r=T(o.dX,o.dY);r[0]+s/2>=t&&r[0]+s/2<=t+s&&r[1]+i/2>=e&&r[1]+i/2<=e+i&&(n.strokeStyle=Ne,n.strokeRect(t,e,s,i))}}function pe(n){switch(n){case"idle":return it.unSeat.bitmap;default:return it.onSeat.bitmap}}function wn(n){const t=O.getState("currentDragEl");if(t){const e=pe(t.status),[s,i]=T(t.dX,t.dY);n.drawImage(e,s,i,x(t.width),x(t.height)),de(n,t,s,i)}}function St(n,t,e,s,i,o){const r=pe(t.status);n.drawImage(r,e,s,i,o),Mn(n,e,s,i,o),de(n,t,e,s)}function de(n,t,e,s){const i=e+x(t.width/2);q(n,Ue,"center","alphabetic",t.baseFontSize),n.fillText(String(t.index),i,s+x(t.width*.3)),t.status==="occupy"?(q(n,Zt,"center","middle",t.nameFontSize),n.fillText(We,i,s+x(t.height/2+2))):t.text&&(q(n,Zt,"center","middle",t.nameFontSize),n.fillText(t.text,i,s+x(t.height/2+2)))}function Gt(n,t,e,s,i,o,r){return{id:n,group_by:t.group_id,index:e,x:s,y:i,isDragging:!1,dX:0,dY:0,width:m,height:M,pos:o,text:r||Math.random().toString(36).substr(2,2),status:"idle",baseFontSize:13,nameFontSize:10}}function yn(n,t){const e=O.getState("graphicMatrix");switch(Reflect.deleteProperty(e.elements,t.id),e.groupElements[n.group_id]=e.groupElements[n.group_id].filter(s=>s!==t.id),n.type){case"circle":Vt(n.group_id);break;case"rectangle":Wt(n.group_id);break;case"strip":oe(n.group_id);break}}function Sn(){O.subscribe("cvs",fe)}function Gn(){O.unsubscribe("cvs",fe),ot=null,X=null}const k=b.getInstance(),ft=3,P=.2,rt=1;function vt(){let n=A().scale;if(n<=P)return 1;if(n>=rt)return n=Math.min(n,ft),Math.round(n/rt*100);const t=(n-P)/(rt-P)*99+1;return Math.round(t)}function vn(n){if(n<=1)return P;if(n>=100){const e=n/100*rt;return Math.min(e,ft)}return(n-1)/99*(rt-P)+P}function Cn(n){let{offsetX:t,offsetY:e,scale:s}=A();const i=1.09,o=s,r=n.offsetX,a=n.offsetY;if(n.deltaY<0){if(s>ft)return;s*=i}else{if(s<P)return;s/=i}const u=s/o;k.updateState("containerTransformState",{...k.getState("containerTransformState"),scale:s,offsetX:r-(r-t)*u,offsetY:a-(a-e)*u})}class Yn{constructor(t,e,s){p(this,"canvas",null);p(this,"ctx",null);p(this,"dragging",!1);p(this,"transformState");p(this,"onTransformStateChangeHandler");this.canvas=s.cvs,this.ctx=s.pen,this.resize(t,e),this.transformState=k.getState("containerTransformState"),this.onTransformStateChangeHandler=this.onTransformStateChange.bind(this),k.subscribe("containerTransformState",this.onTransformStateChangeHandler),this.addEvents()}onTransformStateChange(t){this.transformState=t}resize(t,e){!this.canvas||!this.ctx||(console.log("Size Change",t,e),this.canvas.width=t,this.canvas.height=e,k.updateState("cvs",this.canvas))}addEvents(){this.canvas&&(E.subscribe("mousedown",t=>{t.button===1&&this.resetTransform()}),E.subscribe("mousedown_dnh",t=>{t.button===0&&(this.dragging=!0,k.updateState("containerTransformState",{...this.transformState,lastX:t.clientX,lastY:t.clientY}))}),E.subscribe("mousemove",t=>{if(!this.dragging)return;if(!yt(t)){this.dragging=!1;return}const e=t.clientX-this.transformState.lastX,s=t.clientY-this.transformState.lastY;let i=this.transformState.offsetX+e,o=this.transformState.offsetY+s;k.updateState("containerTransformState",{...this.transformState,lastX:t.clientX,lastY:t.clientY,offsetX:i,offsetY:o})}),E.subscribe("mouseup",()=>{this.dragging=!1}),E.subscribe("wheel",t=>{t.preventDefault(),Cn(t)}))}resetTransform(){ht({scale:1,offsetX:0,offsetY:0})}clear(){k.unsubscribe("containerTransformState",this.onTransformStateChangeHandler)}}const C=class C{constructor(){p(this,"menuElement",null);p(this,"handleDocumentClick");p(this,"currentContextMenuGroup",null);p(this,"currentContextMenuElement",null);p(this,"instances",null);p(this,"contextMenuItems",null);this.handleDocumentClick=this.hide.bind(this)}static getInstance(){return C.instance||(C.instance=new C),C.instance}init(t){this.menuElement||(this.instances=t,this.menuElement=this.createMenuElement(),document.body.appendChild(this.menuElement),this.bindGlobalEvents())}createMenuElement(){const t=document.createElement("ul");return t.className="z-custom-context-menu",t}populateMenuItems(t,e){const s=e||this.menuElement;s&&(s.innerHTML="",t.forEach(i=>{const o=document.createElement("li");o.style.position="relative";const r=document.createElement("span");switch(r.textContent=i.label||"",o.appendChild(r),i.type){case"default":o.className="z-custom-context-menu-item";const a=u=>{i.onClick&&i.onClick()};o.addEventListener("click",a,{once:!0});break;case"divider":o.className="z-custom-context-menu-item-divider";break}if(i.children&&i.children.length>0){o.classList.add("z-custom-context-sub-menu");const a=document.createElement("span");a.className="z-custom-context-sub-menu-arrow",o.appendChild(a);const u=document.createElement("ul");u.className="z-custom-context-submenu",Object.assign(u.style,{top:"0",left:"100%"}),this.populateMenuItems(i.children,u),o.appendChild(u)}s.appendChild(o)}))}show(t,e,s,i,o){var r;!this.menuElement||!this.contextMenuItems||(this.currentContextMenuGroup=i,this.currentContextMenuElement=o,this.populateMenuItems(((r=this.contextMenuItems)==null?void 0:r[s])||[]),this.menuElement&&(this.menuElement.style.left=`${t}px`,this.menuElement.style.top=`${e}px`,setTimeout(()=>{this.menuElement.classList.add("show")},this.menuElement.classList.contains("show")?150:0),this.hide(null)))}hide(t){var s,i;const e=t==null?void 0:t.target;e instanceof HTMLElement&&(e.classList.contains("z-custom-context-sub-menu")||(s=e.parentElement)!=null&&s.classList.contains("z-custom-context-sub-menu"))||(i=this.menuElement)==null||i.classList.remove("show")}generateContextMenuItem(t){const e=(s,i=1)=>t.contextMenuOperateFunc.increaseElement.call(this.instances.Graphic,C.instance.currentContextMenuGroup,C.instance.currentContextMenuElement,s,i);this.contextMenuItems={group:[{label:"区域编辑",type:"default",onClick:()=>{}},{label:"导出图片",type:"default",onClick:()=>t.contextMenuOperateFunc.exportToPng.call(this.instances.Graphic,C.instance.currentContextMenuGroup)},{type:"divider"},{label:"删除区域",type:"default",onClick:()=>t.contextMenuOperateFunc.delGroup.call(this.instances.Graphic,C.instance.currentContextMenuGroup)}],element:[{label:"编辑人员",type:"default",onClick:()=>console.log("编辑人员")},{label:"占位",type:"default",onClick:()=>t.contextMenuOperateFunc.setElementStatus.call(this.instances.Graphic,C.instance.currentContextMenuElement,"occupy")},{label:"删除人员",type:"default",onClick:()=>console.log("删除人员")},{label:"向前插入",type:"default",children:[{label:"插入一个",type:"default",onClick:()=>e("before",1)},{label:"任意数量",type:"default",onClick:()=>e("before",2)}]},{label:"向后插入",type:"default",children:[{label:"插入一个",type:"default",onClick:()=>e("after",1)},{label:"任意数量",type:"default",onClick:()=>e("after",2)}]},{type:"divider"},{label:"删除座位",type:"default",onClick:()=>t.contextMenuOperateFunc.decreaseElement.call(this.instances.Graphic,C.instance.currentContextMenuGroup,C.instance.currentContextMenuElement)}]}}bindGlobalEvents(){document.addEventListener("click",this.handleDocumentClick)}destroy(){this.menuElement&&(this.menuElement.remove(),this.menuElement=null),this.contextMenuItems=null,document.removeEventListener("click",this.handleDocumentClick)}};p(C,"instance");let pt=C;const me=pt.getInstance();function Xn(n,t,e){if(n.button===2){if(e){me.show(n.clientX,n.clientY,"element",t,e);return}t&&me.show(n.clientX,n.clientY,"group",t,e)}}const ge=n=>{const t=ce(n);let e=null;t?(e=le(n,t),e?E.publish("mousedown_element",n,e,t):E.publish("mousedown_group",n,t.group_id)):E.publish("mousedown_dnh",n),Xn(n,t,e),E.publish("mousedown",n)},xe=n=>{pn(n),E.publish("mousemove",n)},Ee=n=>{E.publish("mouseup",n)},be=n=>{E.publish("wheel",n),E.publish("calculateProportion")};function An(n){n.addEventListener("mousedown",ge),n.addEventListener("mousemove",xe),n.addEventListener("mouseup",Ee),n.addEventListener("wheel",be,{passive:!1})}function In(n){n.removeEventListener("mousedown",ge),n.removeEventListener("mousemove",xe),n.removeEventListener("mouseup",Ee),n.removeEventListener("wheel",be),E.clearAll()}const Me=b.getInstance(),we="rectangle";class Bn{constructor(){p(this,"graphicData");this.graphicData=Me.getState("graphicMatrix")}addMatrixGraphic(t,e,s,i=[]){const o=this.graphicData,r=N(),a=qe(r,e,s),[u,c]=Ft(e,s),[l,h]=wt(u,c),f={group_id:r,group_name:t,z_index:0,x:l,y:h,w:u,h:c,hover:!1,size:e*s,type:we,baseFontSize:13};o.groups[we][r]=f,o.elements={...o.elements,...a},o.groupElements[r]=Object.keys(a),Me.updateState("graphicMatrix",o)}clear(){}}const Ct=b.getInstance();function _n(n){let t=1/0,e=1/0,s=-1/0,i=-1/0;for(const a of n){let u=a.x,c=a.y,l=a.w,h=a.h;t=Math.min(t,u),e=Math.min(e,c),s=Math.max(s,u+l),i=Math.max(i,c+h)}const o=s-t,r=i-e;return{minX:t,minY:e,maxX:s,maxY:i,width:o,height:r,offsetX:-t,offsetY:-e}}function ye(n="graphic-export",t){let e=[];if(t){const f=tt(Ct.getGraphicGroupsById(t));f&&(e=[f])}else e=tt(Ct.getGraphicGroupsArr());const{width:s,height:i,offsetX:o,offsetY:r}=_n(e),a=document.createElement("canvas");a.width=s+12,a.height=i+12;const u=a.getContext("2d");if(!u)return;u.fillStyle="#fff",u.fillRect(0,0,a.width,a.height),u.save(),u.translate(o,r);const c=A().scale;for(const f of e.sort((g,S)=>g.z_index-S.z_index)){const[g,S]=ze(f.x,f.y);switch(f.x=g+6,f.y=S+6,f.w=f.w/c,f.h=f.h/c,f.baseFontSize=f.baseFontSize/c,f.type){case"rectangle":$t(u,f,!1);break;case"circle":f.radius=f.radius/c,Kt(u,f);break;case"strip":ne(u,f,!1);break}const F=tt(Ct.getGraphicGroupElementsById(f.group_id));for(const y of F){const At=y.x/c,It=y.y/c;switch(y.x=At,y.y=It,y.baseFontSize=y.baseFontSize/c,y.nameFontSize=y.nameFontSize/c,y.width=y.width/c,y.height=y.height/c,f.type){case"rectangle":Ut(u,y,f);break;case"circle":te(u,y,f);break;case"strip":ie(u,y,f);break}}}u.restore();const l=a.toDataURL("image/png"),h=document.createElement("a");h.href=l,h.download=`${n}.png`,h.click()}const B=b.getInstance();class Tn{constructor(t){p(this,"canvas",null);p(this,"ctx",null);p(this,"lastMousePos",null);p(this,"currentGroup",null);p(this,"dragging",!1);p(this,"currentElement",null);p(this,"elDragging",!1);this.canvas=t.cvs,this.ctx=t.pen,this.addGroupEvents(),this.addElementEvents()}addGroupEvents(){this.canvas&&(E.subscribe("mousedown_group",(t,e)=>{if(t.button===0){const s=B.getGraphicGroupsById(e);if(s){B.updateState("highlightElements",!1),ae(new Set([s.group_id]));const i=D(t);i&&(this.lastMousePos={x:i.mx,y:i.my},this.currentGroup=s,this.currentGroup.z_index=this.currentGroup.z_index+1,this.currentGroup.hover=!0,this.dragging=!0)}}}),E.subscribe("mousemove",t=>{if(!this.dragging||!this.currentGroup)return;if(!yt(t)){this.currentGroup.hover=!1,this.stopDraggingHandler(t,!0);return}const e=D(t),s=this.lastMousePos;if(s&&e){const i=e.mx-s.x,o=e.my-s.y;this.currentGroup.x+=i,this.currentGroup.y+=o,this.lastMousePos={x:e.mx,y:e.my}}}),E.subscribe("mouseup",this.stopDraggingHandler.bind(this)))}addElementEvents(){this.canvas&&(E.subscribe("mousedown_element",(t,e)=>{if(t.button===0){const s=D(t);s&&(this.lastMousePos={x:s.mx,y:s.my},this.currentElement=e,e.dX=s.mx-e.width/2,e.dY=s.my-e.height/2,e.isDragging=!0,this.elDragging=!0,B.updateState("currentDragEl",e))}}),E.subscribe("mousemove",t=>{if(!this.elDragging||!this.currentElement)return;if(!yt(t)){this.elementStopDragging(t);return}const e=D(t),s=this.lastMousePos;if(s&&e){const i=e.mx-s.x,o=e.my-s.y;this.currentElement.dX+=i,this.currentElement.dY+=o,this.lastMousePos={x:e.mx,y:e.my}}}),E.subscribe("mouseup",this.elementStopDragging.bind(this)))}elementStopDragging(t){this.elDragging&&this.currentElement&&(this.currentElement.isDragging=!1,bn(t,this.currentElement),this.elDragging=!1,this.currentElement=null,B.updateState("currentDragEl",null))}stopDraggingHandler(t,e=!1){this.lastMousePos=null,this.dragging&&(e?setTimeout(()=>{B.updateState("highlightElements",!0)},500):B.updateState("highlightElements",!0),this.dragging=!1,this.currentGroup=null,Q(B))}delGroup(t){let e=!0;const s=B.getState("graphicMatrix");if(e=Reflect.deleteProperty(s.groups[t.type],t.group_id),!e||(e=Reflect.deleteProperty(s.groupElements,t.group_id),!e))return e;for(const[i,o]of Object.entries(s.elements))if(o.group_by===t.group_id&&(e=Reflect.deleteProperty(s.elements,i),!e))return e;return B.updateState("graphicMatrix",s),e}exportToPng(t){ye(t.group_name,t.group_id)}increaseElement(t,e,s,i){switch(t.type){case"circle":sn(t,e,s,i);break;case"strip":un(t,e,s,i);break;case"rectangle":je(t,e,s,i);break}}decreaseElement(t,e){yn(t,e),t.size===1&&this.delGroup(t)}setElementStatus(t,e){const s=B.getGraphicGroupElementById(t.id);s&&(s.status=e)}clear(){}}const Se=b.getInstance(),Ge="circle";class kn{constructor(){p(this,"graphicData");this.graphicData=Se.getState("graphicMatrix")}async addCircleGraphic(t,e){const s=this.graphicData,i=N(),{radius:o,w:r,h:a}=Jt(e),[u,c]=wt(r,a),l={group_id:i,group_name:t,z_index:0,x:u,y:c,w:r,h:a,hover:!1,size:e,type:Ge,radius:o,baseFontSize:13},h=nn(l);s.groups[Ge][i]=l,s.elements={...s.elements,...h},s.groupElements[i]=Object.keys(h),Se.updateState("graphicMatrix",s)}clear(){}}const ve=b.getInstance(),Ce="strip";class zn{constructor(){p(this,"graphicData");this.graphicData=ve.getState("graphicMatrix")}async addStripGraphic(t,e,s){const i=this.graphicData,o=N(),[r,a]=ee(e,s),[u,c]=wt(r,a),l={group_id:o,group_name:t,z_index:0,x:u,y:c,w:r,h:a,hover:!1,size:e*2+s*2,type:Ce,baseFontSize:13},h=rn(o,e,s);i.groups[Ce][o]=l,i.elements={...i.elements,...h},i.groupElements[o]=Object.keys(h),ve.updateState("graphicMatrix",i)}clear(){}}const Ye=b.getInstance();class Rn extends Tn{constructor(e){super(e);p(this,"canvas",null);p(this,"ctx",null);p(this,"matrix");p(this,"circle");p(this,"strip");this.canvas=e.cvs,this.ctx=e.pen,this.matrix=new Bn,this.circle=new kn,this.strip=new zn}draw(){if(!this.ctx)return;const e=this.ctx,s=Ye.getGraphicGroupsArr();for(const i of s.sort((o,r)=>o.z_index-r.z_index)){switch(i.type){case"rectangle":$t(e,i);break;case"circle":Kt(e,i);break;case"strip":ne(e,i);break}const o=Ye.getGraphicGroupElementsById(i.group_id);for(const r of o)switch(i.type){case"rectangle":Ut(e,r,i);break;case"circle":te(e,r,i);break;case"strip":ie(e,r,i);break}}wn(this.ctx)}clear(){super.clear(),this.matrix.clear(),this.circle.clear(),this.strip.clear()}operate(){return{addMatrixGraphic:this.matrix.addMatrixGraphic.bind(this.matrix),addCircleGraphic:this.circle.addCircleGraphic.bind(this.circle),addStripGraphic:this.strip.addStripGraphic.bind(this.circle)}}contextMenuOperate(){return{delGroup:super.delGroup,exportToPng:super.exportToPng,increaseElement:super.increaseElement,decreaseElement:super.decreaseElement,setElementStatus:super.setElementStatus}}}function On(n,t){const{graphicOperateFunc:e,contextMenuOperateFunc:s}=Dn(n,t);return{graphicOperateFunc:e,contextMenuOperateFunc:s,getData:()=>tt(b.getInstance().getState("graphicMatrix")),saveToImages:ye}}function Dn(n,t){return t.Graphic=new Rn(n),{graphicOperateFunc:t.Graphic.operate.call(t.Graphic),contextMenuOperateFunc:t.Graphic.contextMenuOperate.call(t.Graphic)}}const L=class L{constructor(){p(this,"toolElement",null);p(this,"handleToolClickBind");p(this,"onTransformStateChangeHandlerBind");this.handleToolClickBind=this.handleToolClick.bind(this),this.onTransformStateChangeHandlerBind=this.onTransformStateChangeHandler.bind(this)}static getInstance(){return L.instance||(L.instance=new L),L.instance}onTransformStateChangeHandler(){const t=document.querySelector(".zx-zoom-scale-proportion");t&&(t.textContent=vt()+"%")}scaleHandler(t){if(t==="situ"){ht({scale:1,offsetX:0,offsetY:0});return}const e=Rt();if(!e)return;let{offsetX:s,offsetY:i,scale:o}=A();const r=e.width/2,a=e.height/2;if(t==="reset"){const u=1/o,c=r-(r-s)*u,l=a-(a-i)*u;ht({offsetX:c,offsetY:l,scale:1})}else{const u=vt(),c=t==="up"?u+50:u-50;if(c>ft*100||c<0)return;const l=vn(c),h=l/o,f=r-(r-s)*h,g=a-(a-i)*h;ht({offsetX:f,offsetY:g,scale:l})}}handleToolClick(t){const e=t.target;if(e)switch(e.className){case"zx-zoom-in-situ":this.scaleHandler("situ");break;case"zx-zoom-scale-up":this.scaleHandler("up");break;case"zx-zoom-scale-proportion":this.scaleHandler("reset");break;case"zx-zoom-scale-down":this.scaleHandler("down");break}}createToolElement(){const t=document.createElement("div"),e=document.createElement("div");e.className="zx-zoom-in-situ";const s=document.createElement("div");s.className="zx-zoom-scale-up";const i=document.createElement("div");i.className="zx-zoom-scale-proportion",i.textContent=vt()+"%";const o=document.createElement("div");return o.className="zx-zoom-scale-down",t.appendChild(e),t.appendChild(s),t.appendChild(i),t.appendChild(o),t.className="z-canvas-tool-zoom",t}init(){var e;if(this.toolElement)return;this.toolElement=this.createToolElement();const t=(e=document.querySelector("#zx-drag-canvas"))==null?void 0:e.parentElement;t&&(t.style.position="relative",t.appendChild(this.toolElement)),this.bindGlobalEvents(),E.subscribe("calculateProportion",this.onTransformStateChangeHandlerBind)}bindGlobalEvents(){this.toolElement&&this.toolElement.addEventListener("click",this.handleToolClickBind)}destroy(){this.toolElement&&(this.toolElement.removeEventListener("click",this.handleToolClickBind),this.toolElement.remove(),this.toolElement=null),E.unsubscribe("calculateProportion",this.onTransformStateChangeHandlerBind)}};p(L,"instance");let Yt=L;const Pn=b.getInstance(),Xt=pt.getInstance(),Xe=Yt.getInstance(),v={cvs:null,pen:null};let Z=null,_=null;const at={Test:null,Graphic:null};function Zn(n){Z||(Z=new Pe(n,v),Z.run(at))}function Ln(n,t){var e;(e=_==null?void 0:_.resize)==null||e.call(_,n,t)}async function Fn(n,t=30){v.cvs=document.createElement("canvas"),v.cvs.setAttribute("id","zx-drag-canvas"),v.cvs.style.display="block",v.cvs.style.backgroundColor=He,v.pen=v.cvs.getContext("2d"),Sn(),_=new Yn(n.clientWidth,n.clientHeight,v),n.appendChild(v.cvs),await it.load().catch(console.error);const e=On(v,at);return Zn(t),An(v.cvs),Xt.init(at),Xt.generateContextMenuItem(e),Xe.init(),e}function Hn(){var n;_==null||_.clear(),_=null,Gn(),Z==null||Z.clear(),Z=null;for(const t in at)(n=at[t])==null||n.clear();b.getInstance().destroy(),b.getInstance().reset(),Pn.unsubscribeAll(),In(v.cvs),Xt.destroy(),Xe.destroy(),v.cvs.remove(),v.cvs=null,v.pen=null}G.exit=Hn,G.init=Fn,G.resize=Ln,G.throttle=Ot,Object.defineProperty(G,Symbol.toStringTag,{value:"Module"})});
